# Forensics and Malware Analysis
![](forensics.png)

This is the first of two chapters that will cover information security detection and response.  Security operations, or secops, consists of people, processes, and technologies that attempt to monitor systems that will detect security events and incidents.  Once detected and validated, efforts must be made to respond to threats by removing and recovering from security incidents.  This chapter will explore the various types of malicious software and how to analyze them to determine what they might do.  We will also introduce digital forensics techniques and tools used to collect digital evidence and conclude activities performed on systems.

**Objectives**
1. Understand the general overview, and analysis of, digital forensics processes.
2. Conduct a forensic investigation with Autopsy.
3. Describe malware types and analysis techniques.
4. Perform detection methods and analysis of malware.
## Forensics

Case Types
Investigation Process
Data Acquisition Types
Data Acquisition Process
Analysis Types
Forensic Tools
Media Types

>[!activity] Activity 11.1 - Forensic Investigation

## Malware Analysis
### Types of Malware
Malware Behavior
Detecting Malware

>[!activity] Activity 11.2 - Malware Detection

### Analyzing Systems
Static Analysis
Dynamic Analysis
Anti-Analysis
### Analysis Tooling
Malware Analysis Workstation
Online Resources
Static Analysis Tools
Dynamic Analysis Tools

> [!activity] Activity 11.3 - Malware Analysis

## Exercises
>[!exercise] Exercise 11.1 - Forensic Investigation
>In this task you will complete various tasks against an acquired USB image from EnCase software using Autopsy on your Windows VM in Bridge Adapter network mode.  You will likely need to increase the Windows VM CPU core count (4) and RAM size (6GB) for the software to run smoothly.  Make sure to revert these settings after the lab.
>#### Step 1 - Install Autopsy
>Within the Windows VM, open a browser and navigate to [https://www.autopsy.com/download/](https://www.autopsy.com/download/) and download the latest Windows 64-bit installer.  The browser may block the installer, make sure to "keep" the installer and then expand the Show More dropdown and "Keep anyway".
>
>Once downloaded, run the installer by double clicking the MSI file in your Downloads folder.  Make sure to run it once as nothing may happen for 30 seconds.  Windows SmartScreen may block the installer, make sure to expand the "More info" to display the "Run anyway" button.
>
>The Autopsy Setup wizard will start.  Follow the steps accepting the defaults and UAC prompts until the software is fully installed.  Make sure to Allow any Java installations when prompted.
>#### Step 2 - Case Setup
>With Autopsy installed, run the application from the Desktop shortcut and Create a New Case.  Name the case "USB Drop", set the Base Directory in a folder on your Desktop, and assign a case number.
>
>Save the forensics.E01 file to your Windows VM and Add Data Source as a "Disk Image or VM File".  Select the forensics.E01 as the Data Source path and select all Ingest Modules.  Once added wait a couple minutes for the analysis to complete by observing the status bar in the bottom right corner of Autopsy to complete.
>
>Once ingest modules have been fully analyzed, expand the Directory Tree's Data Sources hierarchy and confirm the drives folders are displayed (eg "American", "Pictures", and other folders).
>#### Step 3 - Analyze USB
>Analyze the data source by finding the following evidence using the search features (upper right corner) and the tree pane module results.  Make sure to provide a screenshot and description of HOW and WHERE you found the evidence.
>- 2 Email Addresses 
>- 2 URLs  
>- 2 Phone Numbers    
>- 1 Zip File 
>- 1 JPG Metadata 
>- 1 PDF Magic Byte Hex Code 
>- 1 File with an Extension Mismatch
>#### Step 4 - Carve Deleted File
>Find a deleted file (tree) and carve/export (right-click) the file locally to your forensics workstation.  Identify the file type, meta data, and its contents.

>[!exercise] Exercise 11.2 - Malware Detection
>Yara is a malware detection tool supported by a large opensource and commercial community. The tool enables an analyst to quickly create a ruleset that can be used to detect malicious software. In this task you will create a custom Yara rule to identify a malicious file using your Kali VM running in Bridge Adapter network mode.
>#### Step 1 - Install Yara
>In your Kali VM, launch a terminal, update your system, and install yara using apt.
>```bash
>sudo apt update -y
>sudo apt install yara -y
>```
>Verify yara installed by running the help menu and reviewing its capabilities.
>```bash
>yara --help
>```
>#### Step 2 - Analyze Known Malware
>We will analyze the local copy of mimikatz installed on your Kali VM. Mimikatz is a Windows credential dumping utility used to extract Windows passwords and is often integrated in other malware. The 64 bit executable is located at the following path on your Kali VM "/usr/share/windows-resources/mimikatz/x64/mimikatz.exe".
>
>Identify a string that can be used in our Yara rule. Run the "strings" tool on the file and pipe to the "less" utility to identify Windows API crypto functions. BCrypt API functions are used by Windows to perform cryptographic operations which are also used by Mimikatz to extract passwords/hashes. Type "/BCrypt" while in the less editor and press enter.   Press "q" to exit less when satisfied.
>```bash
>strings /usr/share/windows-resources/mimikatz/x64/mimikatz.exe | less
>/BCrypt
>```
>Next, identify some hexcode in the mimikatz.exe. Using hexeditor, identify a unique section of shellcode. While in the editor, go to offset 1382E0 by pressing "CTRL+T" and enter the offset value. This snippet of hexcode may be a good candidate to fingerprint mimikatz. Copy this hex line to use in our Yara. Press "CTRL+C" to exit the editor once finished.
>```bash
>hexeditor /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
>```
>#### Step 3 - Create Custom Yara Rule
>Create a yara ruleset in a file called mimikatz.yar that uses the string and hex code identified in the previous step. Use the following template and your favorite text editor. The strings section informs the yara tool which strings and hexcode to find in a given file. The condition section qualifies which strings need to be present for the rule to trigger.  Make sure to replace HEX_CODE_HERE with the hexcode you found in hexeditor from the previous step.
>```bash
>nano mimikatz.yar
>```
>And enter the following code into mimikatz.yar.
>```yara
>rule mimikatz_x64_exe 
>{ 
>	strings: 
>		$hex = { HEX_CODE_HERE } 
>		$string = "BCrypt" nocase 
>	condition: 
>		all of them 
>} 
>```
> #### Step 4 - Find Malware Using Yara
> With the rule created, run yara on the "/usr/share/windows-resources" directory recursively to identify all files that contain the subject string and hexcode. Files listed indicate a match.
> ```bash
> sudo yara -r mimikatz.yar /usr/share/windows-resources
> ```

>[!exercise] Exercise 11.3 - Malware Analysis
>The WannaCry ransomware leveraged wormable SMB vulnerabilities to rapidly spread across the globe in 2016. In this lab you will use online resources to statically and dynamically analyze WannaCry. You will be in close proximity to this malware so it is best to use one of your VMs with the NAT network mode. Take caution if you decide to download a sample as mishandling it may result in a ransomware infection.
>#### Step 1 - Static Analysis
>Navigate to [https://www.virustotal.com/gui/home/search](https://www.virustotal.com/gui/home/search) , enter the MD5 hash "84c82835a5d21bbcf75a61706d8ab549", and observe most AV vendors identify the hash as WannaCry. 
>
>Select the Details tab and review the properties. Observe what tools compiled the program and when it was created.
>#### Step 2 - Dynamic Analysis
>Navigate to [https://app.any.run/submissions](https://app.any.run/submissions) and type "wannacry" in the search bar. Observe several submissions populate with the MD5 hash "84c82835a5d21bbcf75a61706d8ab549". 
>
>Select one of the submissions to review the already ran dynamic analysis results. Cycle through the screenshots to visually see how the malware behaved. Note, some submissions may only contain one; cycle through submissions until you find one that looks the most interesting. 
>
>Observe the malware's behavior on the right pane. You should be able to see the process trees created and the commands ran in the background. 
>
>Investigate the Network activities in the bottom pane. Discover what connections were made while the malware rand. 
>
>Review the Files activity in the bottom pane and determine what files were read and written to. Any file that ends in ".mnry" extension has been encrypted by the malware.
>#### Step 3 - Explore Any.Run
>Navigate to [https://app.any.run](https://app.any.run/) public submissions section and find a user submission that identifies malware. Perform your own Static and Dynamic analysis using VirusTotal and the already submitted sample in Any.Run. Describe the malware's properties and behavior in a short report.
